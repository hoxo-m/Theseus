---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  out.width = 500
)
```

# Theseus Plot: Visualizing Differences through Replacement in Rate Metrics

<!-- badges: start -->
<!-- badges: end -->

## 1. Overview

In data analysis, when there is a difference in a metric between two groups, we sometimes want to investigate whether there is a subgroup responsible for that difference.
For example, if a certain metric has declined compared with the previous year, you may want to know whether the decline occurred among men, women, or both.
However, such analysis becomes challenging when the metric is a ratio, because unlike volume metrics, ratios cannot be simply aggregated by attribute.

To address this issue, we propose an approach based on the story of the “Ship of Theseus.”
This approach involves gradually replacing the components of one group with those of another, calculating the metric at each step.
The difference in the rate metric at each step can be regarded as the contribution of each subgroup to the overall metric.

Now, we suppose the metric was 6.2% in 2024 and decreased to 5.2% in 2025.
And, we suppose that if the male data in 2024 replace with the male data from 2025 and recalculate the metric, the value decreases by 0.8% to 5.4%.
In this case, the contribution of the male group to the metric change is -0.8%.
Furthermore, we replace the female data from 2024 with that from 2025, the dataset will consist entirely of 2025 data.
Therefore, the metric is 5.2%, which is 0.2% lower than 5.4%, so the contribution of the female group is -0.2%.

When visualized as a graph, it looks as follows.

```{r overview, echo=FALSE}
library(dplyr)
library(nycflights13)
library(Theseus)

data <- flights |>
  filter(!is.na(arr_delay)) |>
  mutate(y = (arr_delay <= 0) / 10) |>
  mutate(gender = case_when(origin == "JFK" ~ "male", 
                            origin == "LGA" ~ "female",
                            TRUE ~ "unknown")) |>
  filter(gender != "unknown")

df1 <- data |> filter(month == 1L)
df2 <- data |> filter(month == 7L)

ship <- create_ship(df1, df2, y = y, labels = c("2024", "2025"), digits = 1L)
ship$plot(gender)
```

From this graph, we can see that the decline in the metric is largely attributable to the male group.
We named this graph the “Theseus Plot.”

The **Theseus** package is designed to easily generate Theseus Plots for various attributes.

## 2. Installation

You can install the development version from GitHub with:

``` r
remotes::install_github("hoxo-m/Theseus")
```

## 3. Details

This is a basic example which shows you how to solve a common problem:

```{r}
library(dplyr)
library(nycflights13)

data <- flights |> 
  filter(!is.na(arr_delay)) |>
  mutate(on_time = arr_delay <= 0)  # arrived on time

data |> select(year, month, day, origin, dest, carrier, dep_delay, on_time) |> head()

data1 <- data |> filter(month == 9L)
data2 <- data |> filter(month == 12L)

data1 |> summarise(on_time_rate = mean(on_time)) |> pull(on_time_rate)
data2 |> summarise(on_time_rate = mean(on_time)) |> pull(on_time_rate)
```

```{r}
library(Theseus)

ship <- create_ship(data1, data2, y = on_time, labels = c("2013-09", "2013-12"))

ship$table(origin)
```

```{r}
ship$plot(origin)
```

```{r}
ship$plot_flip(carrier)
```

```{r}
ship$plot_flip(dep_delay)
```
